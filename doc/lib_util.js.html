<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/util.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/util.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const _ = require('lodash');
const request = require('request-promise');
const {format} = require('util');
const {StatusCodeError} = require('request-promise/errors');

const config = require('./config');
const errors = require('./errors');
const {version} = require('../package.json');

const util = {};

util.USER_AGENT = format(
  'Smartcar/%s (%s; %s) Node.js %s',
  version,
  process.platform,
  process.arch,
  process.version
);

/**
 * Format Access object and set expiration properties.
 *
 * @param {Access} access access object
 * @return {Access}
 */
util.formatAccess = function(access) {
  const expiresIn = access.expires_in * 1000; // normalize to ms
  const expiration = new Date(Date.now() + expiresIn);
  const dayMs = 24 * 60 * 60 * 1000;
  const refreshExpiration = new Date(Date.now() + (60 * dayMs));
  return {
    accessToken: access.access_token,
    refreshToken: access.refresh_token,
    expiration,
    refreshExpiration,
  };
};

/**
 * Form an API request URI
 *
 * @param {String} id vehicle identifier
 * @param {String} endpoint API endpoint
 * @return {String} API request URI
 */
util.getUrl = function(id, endpoint) {
  let url = `${config.api}/v${config.version}/vehicles`;

  if (id) {
    url += `/${id}`;
  }

  if (endpoint) {
    url += `/${endpoint}`;
  }

  return url;
};

util.request = request.defaults({
  json: true,
  headers: {
    'User-Agent': util.USER_AGENT,
  },
  timeout: config.timeout,
});

util.wrap = function(promise) {
  return promise.catch(StatusCodeError, util.catch);
};

util.catch = function(caught) {

  const options = caught.options;
  const body = _.get(caught, 'response.body', {});

  switch (caught.statusCode) {
    case 400:
      throw new errors.ValidationError(body.error_description || body.message);
    case 401:
      throw new errors.AuthenticationError(
        body.error_description || body.message
      );
    case 403:
      throw new errors.PermissionError(options.uri);
    case 404:
      throw new errors.ResourceNotFoundError(options.uri);
    case 409:
      throw new errors.VehicleStateError(body.message, body.code);
    case 429:
      throw new errors.RateLimitingError();
    case 430:
      throw new errors.MonthlyLimitExceeded();
    case 500:
      throw new errors.ServerError();
    case 501:
      switch (body.error) {
        case 'smartcar_not_capable_error':
          throw new errors.SmartcarNotCapableError(body.message);
        default:
          throw new errors.VehicleNotCapableError(options.uri);
      }
    default:
      const e = new errors.SmartcarError(caught.message);
      e.original = caught;
      throw e;
  }
};

module.exports = util;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-errors.html">errors</a></li><li><a href="module-smartcar.html">smartcar</a></li></ul><h3>Classes</h3><ul><li><a href="AuthClient.html">AuthClient</a></li><li><a href="Vehicle.html">Vehicle</a></li></ul><h3>Global</h3><ul><li><a href="global.html#parseAge">parseAge</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Thu Oct 24 2019 12:02:52 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
